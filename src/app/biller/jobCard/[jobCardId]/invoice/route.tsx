import { getJobCardById, getTempCarById } from "@/lib/appwrite";
import { convertStringsToArray, stringToObj } from "@/lib/helper";
import { NextRequest, NextResponse } from "next/server";
import logo from "../../../../../../public/assets/Logomark.png";
import { InvoicePDF } from "@/components/InvoiceTest";
import { renderToStream } from "@react-pdf/renderer";

export async function GET(
  req: NextRequest,
  { params }: { params: { jobCardId: any } }
) {
  console.log("THESE ARE THE PARAMS", params);

  let jobCardObj, carObj: any, prevParts, prevLabour;

  const getJobCardDetails = async () => {
    const jobCardId = params.jobCardId;
    jobCardObj = await getJobCardById(jobCardId);
    console.log("This is the Job Card - ", jobCardObj);

    carObj = await getTempCarById(jobCardObj.carId);
    console.log("This is the car details - ", carObj);

    prevParts = stringToObj(jobCardObj.parts);
    //   setParts(prevParts);

    prevLabour = stringToObj(jobCardObj.labour);
  };

  const base64Logo =
    "data:image/png;base64,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"; // base64 data here

  await getJobCardDetails();
  const purposeOfVisitAndAdvisors: any = convertStringsToArray(carObj?.purposeOfVisitAndAdvisors);

  const stream = await renderToStream(
    <InvoicePDF
      jobCard={jobCardObj}
      parts={prevParts}
      labour={prevLabour}
      logo={base64Logo}
      car={carObj}
      currentDate={new Date()}
      purposeOfVisitAndAdvisors={purposeOfVisitAndAdvisors}
    />
  );

  return new NextResponse(stream as unknown as ReadableStream);
}
